<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboard Pro Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <link rel="stylesheet" href="static/css/shared.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@700&display=swap');
        
        body { 
            background-color: #0f172a; 
            font-family: 'Inter', sans-serif; 
            color: #f8fafc; 
            padding-bottom: 240px;
        }
        
        .timer-font { 
            font-family: 'JetBrains Mono', monospace; 
            letter-spacing: -0.05em; 
        }
        
        .status-dot { 
            width: 8px; 
            height: 8px; 
            border-radius: 50%; 
            display: inline-block; 
            margin-right: 6px; 
        }
        
        .connected { 
            background-color: #10b981; 
            box-shadow: 0 0 8px #10b981; 
        }
        
        .disconnected { 
            background-color: #ef4444; 
            box-shadow: 0 0 8px #ef4444; 
        }

        .team-dot { 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
        }
        
        .main-container {
            display: grid;
            gap: 1rem;
        }

        @media (max-width: 639px) {
            .obs-grid-area {
                max-height: 280px;
                overflow-y: auto;
            }
        }
        
        @media (max-width: 767px) {
            .main-container {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto;
            }
            .timer-section { 
                grid-column: 1 / -1; 
                grid-row: 1; 
            }
            .team1-section { 
                grid-column: 1;
                grid-row: 2;
            }
            .team2-section { 
                grid-column: 2;
                grid-row: 2;
            }
        }
        
        @media (min-width: 768px) {
            .main-container {
                grid-template-columns: 1fr 1fr 1fr;
                grid-template-rows: 1fr;
            }
            .team1-section { grid-column: 1; }
            .timer-section { grid-column: 2; }
            .team2-section { grid-column: 3; }
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            appearance: none;
            -moz-appearance: textfield;
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

    </style>
</head>
<body class="min-h-screen p-2 sm:p-4 md:p-6 flex flex-col items-center justify-center">
    
    <!-- Main Container -->
    <div class="flex flex-col items-center w-full gap-6">

        <!-- Main Panel -->
        <div class="glass-card w-full max-w-5xl rounded-2xl sm:rounded-3xl p-3 sm:p-6 md:p-8 shadow-2xl relative overflow-hidden">
            <div class="flex justify-between items-center mb-4 sm:mb-6 md:mb-8 border-b border-slate-700/50 pb-3 sm:pb-4 md:pb-6">
                <div class="flex items-center gap-2 sm:gap-4">
                    <h1 class="text-base sm:text-xl md:text-2xl font-extrabold text-white">Scoreboard <span class="text-sky-400">Controller</span></h1>
                    <div id="status-text" class="text-[8px] sm:text-[10px] uppercase tracking-widest text-slate-500 flex items-center bg-slate-900/50 px-2 sm:px-3 py-1 rounded-full border border-slate-700/50">
                        <span id="status-dot" class="status-dot disconnected"></span>
                        <span id="conn-text">Connecting...</span>
                    </div>
                </div>
                
                <a href="/setup" class="p-1.5 sm:p-2.5 rounded-lg sm:rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white transition-all border border-slate-700/50 group flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 sm:w-6 sm:h-6 group-hover:rotate-90 transition-transform duration-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </a>
            </div>

            <div class="main-container items-center">
                
                <div class="team1-section text-center">
                    <div class="flex flex-col items-center mb-3 sm:mb-4 md:mb-6">
                        <div id="t1-display-dot" class="team-dot mb-2 sm:mb-3 shadow-[0_0_12px_rgba(59,130,246,0.5)]"></div>
                        <h2 id="t1-display-name" class="text-lg sm:text-2xl md:text-3xl font-black text-white uppercase tracking-tight truncate w-full">TEAM 1</h2>
                    </div>
                    
                    <div class="bg-blue-600/10 rounded-2xl sm:rounded-3xl p-4 sm:p-6 md:p-8 border border-blue-500/20 shadow-inner">
                        <div id="t1-score-val" class="text-5xl sm:text-6xl md:text-7xl lg:text-8xl font-black mb-3 sm:mb-4 md:mb-6 text-white drop-shadow-lg">0</div>
                        <div class="flex gap-2 sm:gap-3">
                            <button onclick="changeScore('team1_score', 1)" class="flex-[2] bg-blue-600 hover:bg-blue-500 p-3 sm:p-4 md:p-5 rounded-xl sm:rounded-2xl font-bold text-lg sm:text-xl md:text-2xl shadow-lg shadow-blue-900/40 active:scale-95 transition-all">+1</button>
                            <button onclick="changeScore('team1_score', -1)" class="flex-1 bg-slate-800 hover:bg-slate-700 p-3 sm:p-4 md:p-5 rounded-xl sm:rounded-2xl font-bold text-lg sm:text-xl md:text-2xl active:scale-95 border border-slate-700 transition-all">-</button>
                        </div>
                    </div>
                </div>
                
                <div class="timer-section space-y-4 sm:space-y-6 md:space-y-8 py-2 sm:py-4">
                    <div class="bg-slate-900/40 rounded-2xl sm:rounded-3xl p-4 sm:p-6 md:p-8 border border-slate-700/50 flex flex-col items-center">
                        <div id="timer" class="timer-font text-4xl sm:text-5xl md:text-6xl lg:text-7xl font-bold text-white tracking-tighter bg-black/40 px-4 sm:px-5 md:px-6 py-3 sm:py-4 md:py-5 rounded-xl sm:rounded-2xl border border-white/5 shadow-inner overflow-hidden whitespace-nowrap text-center w-full">00:00</div>

                        <div class="flex w-full gap-2 sm:gap-3 mb-4 sm:mb-6 mt-4 sm:mt-6"></div>

                        <div class="flex w-full gap-2 sm:gap-3 mb-4 sm:mb-6">
                            <button onclick="timerAction('start')" class="flex-1 bg-emerald-600 hover:bg-emerald-500 py-3 sm:py-4 md:py-5 rounded-xl sm:rounded-2xl font-bold text-sm sm:text-base md:text-lg shadow-lg shadow-emerald-900/30 active:scale-95 transition-all">START</button>
                            <button onclick="timerAction('stop')" class="flex-1 bg-amber-500 text-amber-950 py-3 sm:py-4 md:py-5 rounded-xl sm:rounded-2xl font-bold text-sm sm:text-base md:text-lg shadow-lg shadow-amber-900/20 active:scale-95 transition-all">STOP</button>
                        </div>
                        
                        <div class="w-full space-y-2 sm:space-y-3">
                            <div class="flex flex-col gap-2 sm:gap-3">
                                <div class="relative group">
                                    <input type="number" id="set-time-input" placeholder="Minutes" class="input-field w-full px-3 sm:px-4 py-3 sm:py-4 rounded-lg sm:rounded-xl text-xs sm:text-sm font-bold text-left">
                                    <button onclick="update('set_time', document.getElementById('set-time-input').value)" class="absolute right-1 sm:right-1.5 top-1 sm:top-1.5 bottom-1 sm:bottom-1.5 px-2 sm:px-3 md:px-4 bg-sky-600 hover:bg-sky-500 rounded-md sm:rounded-lg text-[0.6rem] sm:text-xs font-black uppercase transition-all">SET</button>
                                </div>
                                <div class="relative group">
                                    <input type="number" id="extra-time-input" placeholder="Minutes" class="input-field w-full px-3 sm:px-4 py-3 sm:py-4 rounded-lg sm:rounded-xl text-xs sm:text-sm font-bold text-left">
                                    <button onclick="update('extra_time', document.getElementById('extra-time-input').value)" class="absolute right-1 sm:right-1.5 top-1 sm:top-1.5 bottom-1 sm:bottom-1.5 px-2 sm:px-3 md:px-4 bg-rose-600 hover:bg-rose-500 rounded-md sm:rounded-lg text-[0.6rem] sm:text-xs font-black uppercase transition-all">EXTRA TIME</button>
                                </div>
                            </div>
                            <button onclick="timerAction('reset')" class="w-full bg-slate-800 hover:bg-slate-700 py-2 sm:py-3 rounded-lg sm:rounded-xl text-[0.6rem] sm:text-[0.625rem] font-bold uppercase tracking-[0.2em] text-slate-500 hover:text-slate-300 transition-colors border border-slate-700/50">Full Reset</button>
                        </div>
                    </div>
                </div>

                <div class="team2-section text-center">
                    <div class="flex flex-col items-center mb-3 sm:mb-4 md:mb-6">
                        <div id="t2-display-dot" class="team-dot mb-2 sm:mb-3 shadow-[0_0_12px_rgba(244,63,94,0.5)]"></div>
                        <h2 id="t2-display-name" class="text-lg sm:text-2xl md:text-3xl font-black text-white uppercase tracking-tight truncate w-full">TEAM 2</h2>
                    </div>
                    
                    <div class="bg-rose-600/10 rounded-2xl sm:rounded-3xl p-4 sm:p-6 md:p-8 border border-rose-500/20 shadow-inner">
                        <div id="t2-score-val" class="text-5xl sm:text-6xl md:text-7xl lg:text-8xl font-black mb-3 sm:mb-4 md:mb-6 text-white drop-shadow-lg">0</div>
                        <div class="flex gap-2 sm:gap-3">
                            <button onclick="changeScore('team2_score', 1)" class="flex-[2] bg-rose-600 hover:bg-rose-500 p-3 sm:p-4 md:p-5 rounded-xl sm:rounded-2xl font-bold text-lg sm:text-xl md:text-2xl shadow-lg shadow-rose-900/40 active:scale-95 transition-all">+1</button>
                            <button onclick="changeScore('team2_score', -1)" class="flex-1 bg-slate-800 hover:bg-slate-700 p-3 sm:p-4 md:p-5 rounded-xl sm:rounded-2xl font-bold text-lg sm:text-xl md:text-2xl active:scale-95 border border-slate-700 transition-all">-</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications Panel -->
        <div class="glass-card w-full max-w-5xl rounded-2xl sm:rounded-3xl p-4 sm:p-6 shadow-2xl">

            <!-- Team Selector Container -->
            <div class="mb-4 sm:mb-6">
                <div class="team-selector max-w-md mx-auto">
                    <button id="team1-btn" onclick="selectTeam('team1')" class="team-btn active">
                        <span id="team1-btn-name">Team 1</span>
                    </button>
                    <button id="team2-btn" onclick="selectTeam('team2')" class="team-btn">
                        <span id="team2-btn-name">Team 2</span>
                    </button>
                </div>
            </div>

            <!-- Events Container -->
            <div class="main-container items-stretch grid grid-cols-1 md:grid-cols-3">
                
                <!-- Penalty Cards Card -->
                <div class="bg-slate-900/40 rounded-2xl p-4 sm:p-6 border border-slate-700/50 flex flex-col justify-between">
                    <div class="space-y-3">
                        <div class="flex items-center gap-2 mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
                                <rect x="4" y="4" width="16" height="20" rx="2"/>
                            </svg>
                            <h4 class="text-xs font-bold uppercase tracking-wide text-slate-400">Cards</h4>
                        </div>
                        <input type="number" id="card-player" placeholder="Player Number" class="input-field w-full px-4 py-3 rounded-xl text-center text-sm font-bold">
                        <div class="flex gap-2">
                            <button onclick="submitCard('yellow')" class="flex-1 bg-yellow-500 hover:bg-yellow-400 text-yellow-950 py-3 rounded-xl text-[0.65rem] font-black uppercase transition-all active:scale-95 shadow-lg shadow-yellow-900/20">Yellow</button>
                            <button onclick="submitCard('red')" class="flex-1 bg-red-600 hover:bg-red-500 text-white py-3 rounded-xl text-[0.65rem] font-black uppercase transition-all active:scale-95 shadow-lg shadow-red-900/20">Red</button>
                        </div>
                    </div>
                </div>

                <!-- Substitutions Card -->
                <div class="bg-slate-900/40 rounded-2xl p-4 sm:p-6 border border-slate-700/50 flex flex-col justify-between">
                    <div class="space-y-3">
                        <div class="flex items-center gap-2 mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12M8 12h12M8 17h12M3 7h.01M3 12h.01M3 17h.01"/>
                            </svg>
                            <h4 class="text-xs font-bold uppercase tracking-wide text-slate-400">Substitution</h4>
                        </div>
                        <div class="flex items-center gap-2 relative">
                            <div class="relative flex-1 group">
                                <span class="absolute -top-2 left-3 px-1 bg-[#161f31] text-[8px] font-bold text-rose-500 uppercase tracking-tighter z-10">Out</span>
                                <input type="number" id="substitution_player_out" placeholder="00" 
                                    class="input-field w-full px-4 py-4 rounded-xl text-center text-lg font-black border-rose-500/30 focus:border-rose-500 shadow-[inset_0_0_10px_rgba(244,63,94,0.5)]">
                            </div>

                            <div class="text-slate-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                                </svg>
                            </div>

                            <div class="relative flex-1 group">
                                <span class="absolute -top-2 left-3 px-1 bg-[#161f31] text-[8px] font-bold text-emerald-500 uppercase tracking-tighter z-10">In</span>
                                <input type="number" id="substitution_player_in" placeholder="00" 
                                    class="input-field w-full px-4 py-4 rounded-xl text-center text-lg font-black border-emerald-500/30 focus:border-emerald-500 shadow-[inset_0_0_10px_rgba(16,173,123,0.5)]">
                            </div>
                        </div>

                        <button onclick="submitSubstitution()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl text-[0.65rem] font-black uppercase transition-all active:scale-95 shadow-lg shadow-blue-900/40 border border-white/10">
                            Substitution
                        </button>
                    </div>
                </div>

                <!-- Goal Notification Card -->
                <div class="bg-slate-900/40 rounded-2xl p-4 sm:p-6 border border-slate-700/50 flex flex-col justify-between">
                    <div class="space-y-3">
                        <div class="flex items-center gap-2 mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <h4 class="text-xs font-bold uppercase tracking-wide text-slate-400">Goal</h4>
                        </div>
                        <input type="number" id="goal-player" placeholder="Player Number" class="input-field w-full px-4 py-3 rounded-xl text-center text-sm font-bold">
                        <button onclick="submitGoal()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl text-[0.65rem] font-black uppercase transition-all active:scale-95 shadow-lg shadow-emerald-900/20">Goal!</button>
                    </div>
                </div>

            </div>
        </div>

        <!-- Addvert Panel -->
        <div class="glass-card w-full max-w-5xl rounded-2xl sm:rounded-3xl p-4 sm:p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-700/50">
                <div class="flex items-center gap-2 sm:gap-4">
                    <h3 class="text-xs font-bold uppercase tracking-wide text-slate-400">Add Launcher</h3>
                </div>
            </div>
            
            <!-- Dynamic Launcher Buttons Container -->
            <div id="launcher-buttons-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 sm:gap-3">
                <p id="no-launchers-msg" class="text-slate-500 text-xs col-span-full text-center py-4">Loading advertisements...</p>
            </div>
        </div>

        <!-- Formation Card -->
        <div class="glass-card w-full max-w-5xl rounded-2xl sm:rounded-3xl p-4 sm:p-6 shadow-2xl">
            <div class="flex items-center gap-2 mb-3">
                <h3 class="text-xs font-bold uppercase tracking-wide text-slate-400">Lineup</h3>
            </div>
            <div class="main-container items-stretch grid grid-cols-2">
                <button onclick="submitFormation('team1')" class="w-full bg-slate-600 hover:bg-slate-500 text-white py-3 rounded-xl text-[0.65rem] font-black uppercase transition-all active:scale-95 shadow-lg shadow-slate-900/40 border border-white/10">
                    <span id="team1-formation-btn-name">Team 1</span>
                </button>
                <button onclick="submitFormation('team2')" class="w-full bg-slate-600 hover:bg-slate-500 text-white py-3 rounded-xl text-[0.65rem] font-black uppercase transition-all active:scale-95 shadow-lg shadow-slate-900/40 border border-white/10">
                    <span id="team2-formation-btn-name">Team 2</span>
                </button>
            </div>
        </div>

        <!-- Settings Card -->
        <div class="glass-card w-full max-w-5xl rounded-2xl sm:rounded-3xl p-4 sm:p-6 shadow-2xl">
            <div class="flex items-center gap-2 mb-3">
                <h3 class="text-xs font-bold uppercase tracking-wide text-slate-400">Settings</h3>
            </div>
            <div class="main-container items-stretch grid grid-cols-2">
                <a href="/setup-ads" class="p-1.5 sm:p-2.5 rounded-lg sm:rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white transition-all border border-slate-700/50 group flex items-center justify-center">
                    <span>Setup Ads ü§ë</span>
                </a>
                <a href="/setup-ads" class="p-1.5 sm:p-2.5 rounded-lg sm:rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white transition-all border border-slate-700/50 group flex items-center justify-center">
                    <span>Setup OBS Commands ‚öôÔ∏è</span>
                </a>
            </div>
        </div>

        <!-- Footer Panel -->
        <footer class="mt-12 text-center text-slate-400 text-sm pb-6">
            <div class="flex flex-wrap justify-center gap-4">
                
                <div class="glass rounded-lg px-6 py-4 flex items-center gap-4 text-left">
                    <div>
                        <p class="mb-1">
                            <span class="text-slate-300 font-semibold">Smartphone Access</span> 
                        </p>
                        <p class="text-xs font-mono text-green-400 mb-2">
                            http://{{ local_ip }}:{{ port }}
                        </p>
                        <p class="text-[10px] text-slate-500 max-w-[120px] leading-tight">
                            Scan to open interface on mobile.
                        </p>
                    </div>
                    <div class="bg-white p-1 rounded-md shadow-lg">
                        <img src="data:image/png;base64,{{ qr_code }}" alt="QR Code" class="w-20 h-20">
                    </div>
                </div>

                <div class="glass rounded-lg px-6 py-4 inline-block">
                    <p class="mb-1">
                        <span class="text-slate-300 font-semibold">Brigantia Score System</span> 
                        <span class="text-slate-500">v{{ app_version }}</span>
                    </p>
                    <p class="text-xs">
                        Developed by <span class="text-green-400">Diogo Aleixo</span>
                    </p>
                </div>

            </div>
        </footer>

    </div>

    <!-- OBS Command Floating Bar -->
    <div class="fixed bottom-0 left-0 right-0 z-50 bg-slate-900/95 backdrop-blur-md border-t border-slate-700/50 px-4 py-4 sm:px-6 sm:py-5 shadow-[0_-4px_30px_rgba(0,0,0,0.5)] h-fit">
        <div class="max-w-7xl mx-auto">
            <div id="obs-command-bar-buttons" class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3">
                <p class="text-slate-500 text-sm col-span-2 sm:col-span-4">Loading...</p>
            </div>
        </div>
    </div>

    <!-- Spacer to prevent content overlap -->
    <div class="h-32 sm:h-40"></div>

    <script>

        const colorPalette = {
            'Black': '#000000', 'White': '#ffffff', 'Red': '#ef4444', 
            'Orange': '#f97316', 'Yellow': '#facc15', 'Green': '#22c55e', 
            'Cyan': '#06b6d4', 'Blue': '#3b82f6', 'Purple': '#a855f7'
        };

        const socket = io();

        // Timer state
        let timerAnchor = 0;
        let timerOffset = 0;
        let timerRunning = false;
        let extraTime = 0;
        let localTimerInterval = null;

        // Score state
        let scoreState = { team1_score: 0, team2_score: 0 };

        // UI state
        let launcherAdverts = [];
        let selectedTeam = 'team1';

        // Player lookup - maps player number to player ID for each team
        let playerLookup = {
            'team1': {},
            'team2': {}
        };
        let allPlayers = [];

        let obsCommands = [];

        // --- Utility Functions ---

        function formatTime(s) {
            const m = Math.floor(s / 60);
            const sec = s % 60;
            return `${String(m).padStart(2, '0')}:${String(sec).padStart(2, '0')}`;
        }

        function calculateCurrentTime() {
            if (!timerRunning) return timerOffset;
            const now = Date.now() / 1000;
            return timerOffset + Math.floor(now - timerAnchor);
        }

        function updateTimerDisplay() {
            document.getElementById('timer').innerText = formatTime(calculateCurrentTime());
        }

        function startLocalTimer() {
            if (localTimerInterval) clearInterval(localTimerInterval);
            localTimerInterval = setInterval(updateTimerDisplay, 100);
        }

        function updateConnectionStatus(connected) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('conn-text');
            dot.classList.toggle('connected', connected);
            dot.classList.toggle('disconnected', !connected);
            text.innerText = connected ? 'Connected' : 'Disconnected';
        }

        function updateScoreDisplay() {
            document.getElementById('t1-score-val').innerText = scoreState.team1_score;
            document.getElementById('t2-score-val').innerText = scoreState.team2_score;
        }

        function updateTeamDisplay(teams) {
            const team1 = teams.find(t => t.id === 1);
            const team2 = teams.find(t => t.id === 2);

            if (team1) {
                document.getElementById('t1-display-name').innerText = team1.name || 'TEAM 1';
                document.getElementById('t1-display-dot').style.backgroundColor = team1.bg_color || '#3b82f6';
                document.getElementById('team1-btn-name').innerText = team1.name || 'Team 1';
                document.getElementById('team1-formation-btn-name').innerText = team1.name || 'Team 1';
            }
            if (team2) {
                document.getElementById('t2-display-name').innerText = team2.name || 'TEAM 2';
                document.getElementById('t2-display-dot').style.backgroundColor = team2.bg_color || '#f43f5e';
                document.getElementById('team2-btn-name').innerText = team2.name || 'Team 2';
                document.getElementById('team2-formation-btn-name').innerText = team2.name || 'Team 2';
            }
        }

        function selectTeam(team) {
            selectedTeam = team;
            document.getElementById('team1-btn').classList.toggle('active', team === 'team1');
            document.getElementById('team2-btn').classList.toggle('active', team === 'team2');
        }

        function buildPlayerLookup() {
            playerLookup = { 'team1': {}, 'team2': {} };
            allPlayers.forEach(player => {
                const teamKey = player.team_id === 1 ? 'team1' : 'team2';
                playerLookup[teamKey][player.number] = player.id;
            });
        }

        function getPlayerIdByNumber(teamKey, playerNumber) {
            const id = playerLookup[teamKey][playerNumber];
            if (id === undefined) {
                alert(`Player #${playerNumber} not found in roster`);
                return null;
            }
            return id;
        }

        // --- Socket.IO Connection Events ---

        socket.on('connect', () => {
            updateConnectionStatus(true);
            sync();
        });

        socket.on('disconnect', () => {
            updateConnectionStatus(false);
        });

        // --- Socket.IO State Update Listeners ---

        socket.on('update-timer-start', () => syncTimer());
        socket.on('update-timer-stop', () => syncTimer());
        socket.on('update-timer', () => syncTimer());

        socket.on('show-extra-time', (data) => {
            extraTime = data['extra-time'] || 0;
        });

        socket.on('add-to-score', (data) => {
            scoreState = data;
            updateScoreDisplay();
        });

        socket.on('decrease-to-score', (data) => {
            scoreState = data;
            updateScoreDisplay();
        });

        socket.on('update-teams', () => fetchTeams());
        socket.on('update-players', () => fetchPlayers());
        socket.on('update-ads', () => fetchLauncherAdverts());
        socket.on('update-obs-commands', () => fetchOBSCommands());

        // --- HTTP Sync Functions ---

        async function syncTimer() {
            try {
                const res = await fetch('/timer');
                const data = await res.json();
                timerAnchor = data.timer_anchor || 0;
                timerOffset = data.timer_offset || 0;
                timerRunning = data.timer_running || false;
                extraTime = data.extra_time || 0;
                updateTimerDisplay();
            } catch (e) {
                console.error('Timer sync failed:', e);
            }
        }

        async function syncScore() {
            try {
                const res = await fetch('/game_state');
                scoreState = await res.json();
                updateScoreDisplay();
            } catch (e) {
                console.error('Score sync failed:', e);
            }
        }

        async function fetchTeams() {
            try {
                const res = await fetch('/teams');
                const data = await res.json();
                updateTeamDisplay(data.teams || []);
            } catch (e) {
                console.error('Teams fetch failed:', e);
            }
            // Also fetch players to build lookup
            await fetchPlayers();
        }

        async function fetchPlayers() {
            try {
                const res = await fetch('/players');
                const data = await res.json();
                allPlayers = data.players || [];
                buildPlayerLookup();
            } catch (e) {
                console.error('Players fetch failed:', e);
            }
        }

        async function fetchLauncherAdverts() {
            try {
                const res = await fetch('/ads');
                const data = await res.json();
                console.log('All ads from server:', data.ads);
                console.log('Ad types:', data.ads.map(ad => ({ id: ad.id, name: ad.name, type: ad.type, typeOf: typeof ad.type })));
                launcherAdverts = (data.ads || []).filter(
                    ad => ad.type && ad.type.toLowerCase() === 'launcher'
                );
                console.log('Filtered launcher ads:', launcherAdverts);
                renderLauncherButtons();
            } catch (e) {
                console.error('Ads fetch failed:', e);
            }
        }

        async function fetchOBSCommands() {
            try {
                const res = await fetch('/obs-commands');
                const data = await res.json();
                obsCommands = data.obs_commands || [];
                renderOBSCommandBar();
            } catch (e) {
                console.error('OBS commands fetch failed:', e);
            }
        }

        async function sync() {
            await Promise.all([
                syncTimer(),
                syncScore(),
                fetchTeams(),
                fetchPlayers(),
                fetchLauncherAdverts(),
                fetchOBSCommands(),
            ]);
        }

        // --- Action Functions ---

        function update(key, value) {
            const minutes = parseInt(value, 10);
            if (isNaN(minutes) || minutes < 0) {
                alert('Please enter a valid number of minutes');
                return;
            }
            const seconds = minutes * 60;

            if (key === 'set_time') {
                socket.emit('set-timer', { 'set': seconds });
            } else if (key === 'extra_time') {
                socket.emit('set-extra-time', { 'extra-time': minutes });
            }
        }

        function changeScore(teamKey, delta) {
            const team = teamKey.replace('_score', '');
            if (delta > 0) {
                socket.emit('trigger-goal', { team });
            } else {
                socket.emit('cancel-goal', { team });
            }
        }

        function timerAction(action) {
            if (action === 'start') socket.emit('start-timer');
            else if (action === 'stop') socket.emit('stop-timer');
            else if (action === 'reset') socket.emit('reset-timer');
        }

        function submitCard(cardType) {
            const playerNumber = document.getElementById('card-player').value;
            if (!playerNumber) {
                alert('Please enter player number');
                return;
            }
            const playerId = getPlayerIdByNumber(selectedTeam, parseInt(playerNumber, 10));
            if (playerId === null) return;
            
            socket.emit('trigger-event', {
                type: 'card',
                team: selectedTeam,
                player_id: playerId,
                card_type: cardType
            });
            document.getElementById('card-player').value = '';
        }

        function submitSubstitution() {
            const playerOutNumber = document.getElementById('substitution_player_out').value;
            const playerInNumber = document.getElementById('substitution_player_in').value;
            if (!playerOutNumber || !playerInNumber) {
                alert('Please fill in both player numbers');
                return;
            }
            
            const playerOutId = getPlayerIdByNumber(selectedTeam, parseInt(playerOutNumber, 10));
            const playerInId = getPlayerIdByNumber(selectedTeam, parseInt(playerInNumber, 10));
            if (playerOutId === null || playerInId === null) return;
            
            socket.emit('trigger-event', {
                type: 'substitution',
                team: selectedTeam,
                player_id_out: playerOutId,
                player_id_in: playerInId
            });
            document.getElementById('substitution_player_out').value = '';
            document.getElementById('substitution_player_in').value = '';
        }

        function submitGoal() {
            const playerNumber = document.getElementById('goal-player').value;
            if (!playerNumber) {
                alert('Please enter scorer number');
                return;
            }
            const playerId = getPlayerIdByNumber(selectedTeam, parseInt(playerNumber, 10));
            if (playerId === null) return;
            
            socket.emit('trigger-event', {
                type: 'goal',
                team: selectedTeam,
                player_id: playerId
            });
            document.getElementById('goal-player').value = '';
        }

        function submitFormation(team) {
            socket.emit('trigger-event', { 'type': 'formation', 'team': team });
        }

        function escapeHtml(str) {
            if (!str) return "";
            return str
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function renderLauncherButtons() {
            const container =
                document.getElementById("launcher-buttons-container");
            if (launcherAdverts.length === 0) {
                container.innerHTML =
                    '<p class="text-slate-500 text-xs col-span-full text-center py-4">No launcher advertisements configured</p>';
                return;
            }
            container.innerHTML = launcherAdverts
                .map(
                    (ad) => `
                <button 
                    onclick="triggerAdvert(${ad.id})" 
                    class="bg-gradient-to-br from-amber-600 to-amber-700 hover:from-amber-500 hover:to-amber-600 text-white py-3 px-4 rounded-xl text-xs sm:text-sm font-bold uppercase transition-all active:scale-95 shadow-lg shadow-amber-900/30 border border-amber-500/20 truncate"
                    title="${escapeHtml(ad.sponsor ? ad.sponsor + ' - ' : '')}${escapeHtml(ad.name)}"
                >
                    ${escapeHtml(ad.name) || "Unnamed Ad"}
                </button>
            `
                )
                .join("");
        }

        function renderOBSCommandBar() {
            const container = document.getElementById('obs-command-bar-buttons');
            if (obsCommands.length === 0) {
                container.innerHTML =
                    '<p class="text-slate-500 text-sm col-span-2 sm:col-span-4">No OBS commands configured</p>';
                return;
            }
            container.innerHTML = obsCommands
                .map((cmd) => {
                    const bgColor = cmd.color || '#000000';
                    // Pick white or black text based on luminance
                    const r = parseInt(bgColor.slice(1, 3), 16);
                    const g = parseInt(bgColor.slice(3, 5), 16);
                    const b = parseInt(bgColor.slice(5, 7), 16);
                    const lum = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
                    const textColor = lum > 0.5 ? '#000000' : '#ffffff';
                    return `
                        <button
                            onclick="triggerOBSCommand(${cmd.id})"
                            style="background-color: ${bgColor}; color: ${textColor};"
                            class="px-6 sm:px-8 py-4 sm:py-6 rounded-xl text-base sm:text-lg font-black uppercase transition-all active:scale-95 hover:opacity-80 shadow-lg border border-white/20 flex flex-col items-center justify-center gap-1"
                            title="${escapeHtml(cmd.shortcut || '')}"
                        >
                            <span>${escapeHtml(cmd.name) || 'Unnamed'}</span>
                            <span class="text-[10px] sm:text-xs opacity-75 font-mono">${escapeHtml(cmd.shortcut || 'N/A')}</span>
                        </button>`;
                })
                .join('');
        }

        function triggerOBSCommand(commandId) {
            socket.emit('trigger-obs-command', { id: commandId });
        }

        function triggerAdvert(advertId) {
            socket.emit('trigger-ad', { id: advertId });
        }

        // --- Initialize ---

        startLocalTimer();
        setInterval(sync, 5000);
        sync();
        selectTeam('team1');

    </script>
</body>
</html>