<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboard Pro Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="css/shared.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@700&display=swap');
        
        body { 
            background-color: #0f172a; 
            font-family: 'Inter', sans-serif; 
            color: #f8fafc; 
        }
        
        .timer-font { 
            font-family: 'JetBrains Mono', monospace; 
            letter-spacing: -0.05em; 
        }
        
        .status-dot { 
            width: 8px; 
            height: 8px; 
            border-radius: 50%; 
            display: inline-block; 
            margin-right: 6px; 
        }
        
        .connected { 
            background-color: #10b981; 
            box-shadow: 0 0 8px #10b981; 
        }
        
        .disconnected { 
            background-color: #ef4444; 
            box-shadow: 0 0 8px #ef4444; 
        }

        .team-dot { 
            width: 12px; 
            height: 12px; 
            border-radius: 50%; 
        }
        
        .main-container {
            display: grid;
            gap: 1rem;
        }
        
        @media (max-width: 767px) {
            .main-container {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto;
            }
            .timer-section { 
                grid-column: 1 / -1; 
                grid-row: 1; 
            }
            .team1-section { 
                grid-column: 1;
                grid-row: 2;
            }
            .team2-section { 
                grid-column: 2;
                grid-row: 2;
            }
        }
        
        @media (min-width: 768px) {
            .main-container {
                grid-template-columns: 1fr 1fr 1fr;
                grid-template-rows: 1fr;
            }
            .team1-section { grid-column: 1; }
            .timer-section { grid-column: 2; }
            .team2-section { grid-column: 3; }
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            appearance: none;
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="min-h-screen p-2 sm:p-4 md:p-6 flex flex-col items-center justify-center">
    
    <!-- Main Container -->
    <div class="flex flex-col items-center w-full gap-6">

        <!-- Main Panel -->
        <div class="glass-card w-full max-w-5xl rounded-2xl sm:rounded-3xl p-3 sm:p-6 md:p-8 shadow-2xl relative overflow-hidden">
            <div class="flex justify-between items-center mb-4 sm:mb-6 md:mb-8 border-b border-slate-700/50 pb-3 sm:pb-4 md:pb-6">
                <div class="flex items-center gap-2 sm:gap-4">
                    <h1 class="text-base sm:text-xl md:text-2xl font-extrabold text-white">Scoreboard <span class="text-sky-400">Controller</span></h1>
                    <div id="status-text" class="text-[8px] sm:text-[10px] uppercase tracking-widest text-slate-500 flex items-center bg-slate-900/50 px-2 sm:px-3 py-1 rounded-full border border-slate-700/50">
                        <span id="status-dot" class="status-dot disconnected"></span>
                        <span id="conn-text">Connecting...</span>
                    </div>
                </div>
                
                <a href="/setup" class="p-1.5 sm:p-2.5 rounded-lg sm:rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white transition-all border border-slate-700/50 group flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 sm:w-6 sm:h-6 group-hover:rotate-90 transition-transform duration-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </a>
            </div>

            <div class="main-container items-center">
                
                <div class="team1-section text-center">
                    <div class="flex flex-col items-center mb-3 sm:mb-4 md:mb-6">
                        <div id="t1-display-dot" class="team-dot mb-2 sm:mb-3 shadow-[0_0_12px_rgba(59,130,246,0.5)]"></div>
                        <h2 id="t1-display-name" class="text-lg sm:text-2xl md:text-3xl font-black text-white uppercase tracking-tight truncate w-full">TEAM 1</h2>
                    </div>
                    
                    <div class="bg-blue-600/10 rounded-2xl sm:rounded-3xl p-4 sm:p-6 md:p-8 border border-blue-500/20 shadow-inner">
                        <div id="t1-score-val" class="text-5xl sm:text-6xl md:text-7xl lg:text-8xl font-black mb-3 sm:mb-4 md:mb-6 text-white drop-shadow-lg">0</div>
                        <div class="flex gap-2 sm:gap-3">
                            <button onclick="changeScore('team1_score', 1)" class="flex-[2] bg-blue-600 hover:bg-blue-500 p-3 sm:p-4 md:p-5 rounded-xl sm:rounded-2xl font-bold text-lg sm:text-xl md:text-2xl shadow-lg shadow-blue-900/40 active:scale-95 transition-all">+1</button>
                            <button onclick="changeScore('team1_score', -1)" class="flex-1 bg-slate-800 hover:bg-slate-700 p-3 sm:p-4 md:p-5 rounded-xl sm:rounded-2xl font-bold text-lg sm:text-xl md:text-2xl active:scale-95 border border-slate-700 transition-all">-</button>
                        </div>
                    </div>
                </div>
                
                <div class="timer-section space-y-4 sm:space-y-6 md:space-y-8 py-2 sm:py-4">
                    <div class="bg-slate-900/40 rounded-2xl sm:rounded-3xl p-4 sm:p-6 md:p-8 border border-slate-700/50 flex flex-col items-center">
                        <div id="timer" class="timer-font text-4xl sm:text-5xl md:text-6xl lg:text-7xl font-bold text-white tracking-tighter bg-black/40 px-4 sm:px-5 md:px-6 py-3 sm:py-4 md:py-5 rounded-xl sm:rounded-2xl border border-white/5 shadow-inner overflow-hidden whitespace-nowrap text-center w-full">00:00</div>

                        <div class="flex w-full gap-2 sm:gap-3 mb-4 sm:mb-6 mt-4 sm:mt-6"></div>

                        <div class="flex w-full gap-2 sm:gap-3 mb-4 sm:mb-6">
                            <button onclick="timerAction('start')" class="flex-1 bg-emerald-600 hover:bg-emerald-500 py-3 sm:py-4 md:py-5 rounded-xl sm:rounded-2xl font-bold text-sm sm:text-base md:text-lg shadow-lg shadow-emerald-900/30 active:scale-95 transition-all">START</button>
                            <button onclick="timerAction('stop')" class="flex-1 bg-amber-500 text-amber-950 py-3 sm:py-4 md:py-5 rounded-xl sm:rounded-2xl font-bold text-sm sm:text-base md:text-lg shadow-lg shadow-amber-900/20 active:scale-95 transition-all">STOP</button>
                        </div>
                        
                        <div class="w-full space-y-2 sm:space-y-3">
                            <div class="flex flex-col gap-2 sm:gap-3">
                                <div class="relative group">
                                    <input type="number" id="set-time-input" placeholder="Minutes" class="input-field w-full px-3 sm:px-4 py-3 sm:py-4 rounded-lg sm:rounded-xl text-xs sm:text-sm font-bold text-left">
                                    <button onclick="update('set_time', document.getElementById('set-time-input').value)" class="absolute right-1 sm:right-1.5 top-1 sm:top-1.5 bottom-1 sm:bottom-1.5 px-2 sm:px-3 md:px-4 bg-sky-600 hover:bg-sky-500 rounded-md sm:rounded-lg text-[0.6rem] sm:text-xs font-black uppercase transition-all">SET</button>
                                </div>
                                <div class="relative group">
                                    <input type="number" id="extra-time-input" placeholder="Minutes" class="input-field w-full px-3 sm:px-4 py-3 sm:py-4 rounded-lg sm:rounded-xl text-xs sm:text-sm font-bold text-left">
                                    <button onclick="update('extra_time', document.getElementById('extra-time-input').value)" class="absolute right-1 sm:right-1.5 top-1 sm:top-1.5 bottom-1 sm:bottom-1.5 px-2 sm:px-3 md:px-4 bg-rose-600 hover:bg-rose-500 rounded-md sm:rounded-lg text-[0.6rem] sm:text-xs font-black uppercase transition-all">EXTRA TIME</button>
                                </div>
                            </div>
                            <button onclick="timerAction('reset')" class="w-full bg-slate-800 hover:bg-slate-700 py-2 sm:py-3 rounded-lg sm:rounded-xl text-[0.6rem] sm:text-[0.625rem] font-bold uppercase tracking-[0.2em] text-slate-500 hover:text-slate-300 transition-colors border border-slate-700/50">Full Reset</button>
                        </div>
                    </div>
                </div>

                <div class="team2-section text-center">
                    <div class="flex flex-col items-center mb-3 sm:mb-4 md:mb-6">
                        <div id="t2-display-dot" class="team-dot mb-2 sm:mb-3 shadow-[0_0_12px_rgba(244,63,94,0.5)]"></div>
                        <h2 id="t2-display-name" class="text-lg sm:text-2xl md:text-3xl font-black text-white uppercase tracking-tight truncate w-full">TEAM 2</h2>
                    </div>
                    
                    <div class="bg-rose-600/10 rounded-2xl sm:rounded-3xl p-4 sm:p-6 md:p-8 border border-rose-500/20 shadow-inner">
                        <div id="t2-score-val" class="text-5xl sm:text-6xl md:text-7xl lg:text-8xl font-black mb-3 sm:mb-4 md:mb-6 text-white drop-shadow-lg">0</div>
                        <div class="flex gap-2 sm:gap-3">
                            <button onclick="changeScore('team2_score', 1)" class="flex-[2] bg-rose-600 hover:bg-rose-500 p-3 sm:p-4 md:p-5 rounded-xl sm:rounded-2xl font-bold text-lg sm:text-xl md:text-2xl shadow-lg shadow-rose-900/40 active:scale-95 transition-all">+1</button>
                            <button onclick="changeScore('team2_score', -1)" class="flex-1 bg-slate-800 hover:bg-slate-700 p-3 sm:p-4 md:p-5 rounded-xl sm:rounded-2xl font-bold text-lg sm:text-xl md:text-2xl active:scale-95 border border-slate-700 transition-all">-</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications Panel -->
        <div class="glass-card w-full max-w-5xl rounded-2xl sm:rounded-3xl p-4 sm:p-6 shadow-2xl">

            <!-- Team Selector Container -->
            <div class="mb-4 sm:mb-6">
                <div class="team-selector max-w-md mx-auto">
                    <button id="team1-btn" onclick="selectTeam('team1')" class="team-btn active">
                        <span id="team1-btn-name">Team 1</span>
                    </button>
                    <button id="team2-btn" onclick="selectTeam('team2')" class="team-btn">
                        <span id="team2-btn-name">Team 2</span>
                    </button>
                </div>
            </div>

            <!-- Events Container -->
            <div class="main-container items-stretch grid grid-cols-1 md:grid-cols-3">
                
                <!-- Penalty Cards Card -->
                <div class="bg-slate-900/40 rounded-2xl p-4 sm:p-6 border border-slate-700/50 flex flex-col justify-between">
                    <div class="space-y-3">
                        <div class="flex items-center gap-2 mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
                                <rect x="4" y="4" width="16" height="20" rx="2"/>
                            </svg>
                            <h4 class="text-xs font-bold uppercase tracking-wide text-slate-400">Cards</h4>
                        </div>
                        <input type="number" id="card-player" placeholder="Player Number" class="input-field w-full px-4 py-3 rounded-xl text-center text-sm font-bold">
                        <div class="flex gap-2">
                            <button onclick="submitCard('yellow')" class="flex-1 bg-yellow-500 hover:bg-yellow-400 text-yellow-950 py-3 rounded-xl text-[0.65rem] font-black uppercase transition-all active:scale-95 shadow-lg shadow-yellow-900/20">Yellow</button>
                            <button onclick="submitCard('red')" class="flex-1 bg-red-600 hover:bg-red-500 text-white py-3 rounded-xl text-[0.65rem] font-black uppercase transition-all active:scale-95 shadow-lg shadow-red-900/20">Red</button>
                        </div>
                    </div>
                </div>

                <!-- Substitutions Card -->
                <div class="bg-slate-900/40 rounded-2xl p-4 sm:p-6 border border-slate-700/50 flex flex-col justify-between">
                    <div class="space-y-3">
                        <div class="flex items-center gap-2 mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12M8 12h12M8 17h12M3 7h.01M3 12h.01M3 17h.01"/>
                            </svg>
                            <h4 class="text-xs font-bold uppercase tracking-wide text-slate-400">Substitution</h4>
                        </div>
                        <div class="flex items-center gap-2 relative">
                            <div class="relative flex-1 group">
                                <span class="absolute -top-2 left-3 px-1 bg-[#161f31] text-[8px] font-bold text-rose-500 uppercase tracking-tighter z-10">Out</span>
                                <input type="number" id="substitution_player_out" placeholder="00" 
                                    class="input-field w-full px-4 py-4 rounded-xl text-center text-lg font-black border-rose-500/30 focus:border-rose-500 shadow-[inset_0_0_10px_rgba(244,63,94,0.5)]">
                            </div>

                            <div class="text-slate-600">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                                </svg>
                            </div>

                            <div class="relative flex-1 group">
                                <span class="absolute -top-2 left-3 px-1 bg-[#161f31] text-[8px] font-bold text-emerald-500 uppercase tracking-tighter z-10">In</span>
                                <input type="number" id="substitution_player_in" placeholder="00" 
                                    class="input-field w-full px-4 py-4 rounded-xl text-center text-lg font-black border-emerald-500/30 focus:border-emerald-500 shadow-[inset_0_0_10px_rgba(16,173,123,0.5)]">
                            </div>
                        </div>

                        <button onclick="submitSubstitution()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl text-[0.65rem] font-black uppercase transition-all active:scale-95 shadow-lg shadow-blue-900/40 border border-white/10">
                            Substitution
                        </button>
                    </div>
                </div>

                <!-- Goal Notification Card -->
                <div class="bg-slate-900/40 rounded-2xl p-4 sm:p-6 border border-slate-700/50 flex flex-col justify-between">
                    <div class="space-y-3">
                        <div class="flex items-center gap-2 mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-emerald-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <h4 class="text-xs font-bold uppercase tracking-wide text-slate-400">Goal</h4>
                        </div>
                        <input type="number" id="goal-player" placeholder="Player Number" class="input-field w-full px-4 py-3 rounded-xl text-center text-sm font-bold">
                        <button onclick="submitGoal()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-xl text-[0.65rem] font-black uppercase transition-all active:scale-95 shadow-lg shadow-emerald-900/20">Goal!</button>
                    </div>
                </div>

            </div>
        </div>

        <!-- Addvert Panel -->
        <div class="glass-card w-full max-w-5xl rounded-2xl sm:rounded-3xl p-4 sm:p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4 pb-2 border-b border-slate-700/50">
                <div class="flex items-center gap-2 sm:gap-4">
                    <h3 class="text-xs font-bold uppercase tracking-wide text-slate-400">Add Launcher</h3>
                </div>
                
                <a href="/setup-adds" class="p-1.5 sm:p-2.5 rounded-lg sm:rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white transition-all border border-slate-700/50 group flex items-center justify-center">
                    <span>ü§ë</span>
                </a>
            </div>
            
            <!-- Dynamic Launcher Buttons Container -->
            <div id="launcher-buttons-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 sm:gap-3">
                <p id="no-launchers-msg" class="text-slate-500 text-xs col-span-full text-center py-4">Loading advertisements...</p>
            </div>
        </div>

        <!-- Formation Card -->
        <div class="glass-card w-full max-w-5xl rounded-2xl sm:rounded-3xl p-4 sm:p-6 shadow-2xl">
            <div class="flex items-center gap-2 mb-3">
                <h3 class="text-xs font-bold uppercase tracking-wide text-slate-400">Lineup</h3>
            </div>
            <div class="main-container items-stretch grid grid-cols-2">
                <button onclick="submitFormation('team1')" class="w-full bg-slate-600 hover:bg-slate-500 text-white py-3 rounded-xl text-[0.65rem] font-black uppercase transition-all active:scale-95 shadow-lg shadow-slate-900/40 border border-white/10">
                    <span id="team1-formation-btn-name">Team 1</span>
                </button>
                <button onclick="submitFormation('team2')" class="w-full bg-slate-600 hover:bg-slate-500 text-white py-3 rounded-xl text-[0.65rem] font-black uppercase transition-all active:scale-95 shadow-lg shadow-slate-900/40 border border-white/10">
                    <span id="team2-formation-btn-name">Team 2</span>
                </button>
            </div>
        </div>

        <!-- Footer Panel -->
        <footer class="mt-12 text-center text-slate-400 text-sm pb-6">
            <div class="flex flex-wrap justify-center gap-4">
                
                <div class="glass rounded-lg px-6 py-4 flex items-center gap-4 text-left">
                    <div>
                        <p class="mb-1">
                            <span class="text-slate-300 font-semibold">Smartphone Access</span> 
                        </p>
                        <p class="text-xs font-mono text-green-400 mb-2">
                            http://{{ local_ip }}:{{ port }}
                        </p>
                        <p class="text-[10px] text-slate-500 max-w-[120px] leading-tight">
                            Scan to open interface on mobile.
                        </p>
                    </div>
                    <div class="bg-white p-1 rounded-md shadow-lg">
                        <img src="data:image/png;base64,{{ qr_code }}" alt="QR Code" class="w-20 h-20">
                    </div>
                </div>

                <div class="glass rounded-lg px-6 py-4 inline-block">
                    <p class="mb-1">
                        <span class="text-slate-300 font-semibold">Brigantia Score System</span> 
                        <span class="text-slate-500">v{{ app_version }}</span>
                    </p>
                    <p class="text-xs">
                        Developed by <span class="text-green-400">Diogo Aleixo</span>
                    </p>
                </div>

            </div>
        </footer>

    </div>

    <script>
        const colorPalette = {
            'Black': '#000000', 'White': '#ffffff', 'Red': '#ef4444', 
            'Orange': '#f97316', 'Yellow': '#facc15', 'Green': '#22c55e', 
            'Cyan': '#06b6d4', 'Blue': '#3b82f6', 'Purple': '#a855f7'
        };

        const checkSvg = `
            <svg class="check-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="4" d="M5 13l4 4L19 7"></path>
            </svg>
        `;

        let currentState = {};
        let selectedTeam = 'team1';
        
        // Timer state
        let timerAnchor = null;
        let timerOffset = 0;
        let timerRunning = false;
        let lastTimerUpdate = 0;
        let localTimerInterval = null;
        let clockOffset = 0;

        // Advertisement state
        let launcherAdverts = [];


        function formatTime(s) {
            const m = Math.floor(s/60);
            const sec = s % 60;
            return `${String(m).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
        }

        function calculateCurrentTime() {
            if (!timerRunning) {
                return timerOffset;
            }
            const now = Date.now() / 1000 + clockOffset;
            const elapsed = Math.floor(now - timerAnchor);
            return timerOffset + elapsed;
        }

        function updateTimerDisplay() {
            const seconds = calculateCurrentTime();
            document.getElementById('timer').innerText = formatTime(seconds);
        }

        function startLocalTimer() {
            if (localTimerInterval) {
                clearInterval(localTimerInterval);
            }
            localTimerInterval = setInterval(updateTimerDisplay, 100);
        }

        async function update(key, value) {
            try {
                await fetch('/state', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({[key]: value})
                });
                if (key == 'extra_time') {
                    document.getElementById('extra-time-input').value = '';
                }
                else if (key == 'set_time') {
                    document.getElementById('set-time-input').value = '';
                }
            } catch(e) { console.error(e); }
        }

        async function changeScore(teamKey, delta) {
            const newVal = Math.max(0, (currentState[teamKey] || 0) + delta);
            update(teamKey, newVal);
        }

        async function timerAction(action) {
            await fetch('/state', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({timer_action: action})
            });
        }

        function selectTeam(team) {
            selectedTeam = team;
            document.getElementById('team1-btn').classList.toggle('active', team === 'team1');
            document.getElementById('team2-btn').classList.toggle('active', team === 'team2');
        }

        async function submitCard(cardType) {
            const player = document.getElementById('card-player').value;
            if (!player) {
                alert('Por favor insira o n√∫mero do jogador');
                return;
            }

            try {
                const res = await fetch('/events', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: 'card',
                        team: selectedTeam,
                        player: player,
                        card_type: cardType
                    })
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('card-player').value = '';
                    console.log('Card event submitted successfully, ID:', data.event_id);
                } else {
                    alert('Erro ao submeter cart√£o: ' + (data.error || 'Unknown error'));
                }
            } catch(e) {
                console.error('Error submitting card:', e);
                alert('Erro de conex√£o ao submeter cart√£o');
            }
        }

        async function submitSubstitution() {
            const playerOut = document.getElementById('substitution_player_out').value;
            const playerIn = document.getElementById('substitution_player_in').value;
            
            if (!playerOut || !playerIn) {
                alert('Por favor insira ambos os n√∫meros dos jogadores');
                return;
            }

            try {
                const res = await fetch('/events', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: 'substitution',
                        team: selectedTeam,
                        player_out: playerOut,
                        player_in: playerIn
                    })
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('substitution_player_out').value = '';
                    document.getElementById('substitution_player_in').value = '';
                    console.log('Substitution event submitted successfully, ID:', data.event_id);
                } else {
                    alert('Erro ao submeter substitui√ß√£o: ' + (data.error || 'Unknown error'));
                }
            } catch(e) {
                console.error('Error submitting substitution:', e);
                alert('Erro de conex√£o ao submeter substitui√ß√£o');
            }
        }

        async function submitGoal() {
            const player = document.getElementById('goal-player').value;
            if (!player) {
                alert('Por favor insira o n√∫mero do marcador');
                return;
            }

            try {
                const res = await fetch('/events', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        type: 'goal',
                        team: selectedTeam,
                        player: player
                    })
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('goal-player').value = '';
                    console.log('Goal event submitted successfully, ID:', data.event_id);
                } else {
                    alert('Erro ao submeter golo: ' + (data.error || 'Unknown error'));
                }
            } catch(e) {
                console.error('Error submitting goal:', e);
                alert('Erro de conex√£o ao submeter golo');
            }
        }

        async function submitFormation(team) {
            try {
                const res = await fetch("/events", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ type: "formation", team: team }),
                });
                const data = await res.json();
                if (data.success) {
                    console.log('Formation event submitted successfully, ID:', data.event_id);
                } else {
                    alert('Erro ao submeter forma√ß√£o: ' + (data.error || 'Unknown error'));
                }
            } catch(e) {
                console.error('Error resquesting formation', e);
                alert('Erro de conex√£o ao submeter forma√ß√£o');
            }
        }

        async function fetchLauncherAdverts() {
            try {
                const res = await fetch('/setup-adds/data');
                if (!res.ok) throw new Error('Failed to fetch adverts');
                
                const adverts = await res.json();
                
                // Filter only Launcher action adverts
                launcherAdverts = adverts.filter(ad => ad.action === 'Launcher');
                
                renderLauncherButtons();
            } catch (e) {
                console.error('Error fetching adverts:', e);
                document.getElementById('no-launchers-msg').innerText = 'Error loading advertisements';
            }
        }

        function renderLauncherButtons() {
            const container = document.getElementById('launcher-buttons-container');
            
            if (launcherAdverts.length === 0) {
                container.innerHTML = '<p class="text-slate-500 text-xs col-span-full text-center py-4">No launcher advertisements configured</p>';
                return;
            }
            
            container.innerHTML = launcherAdverts.map(ad => `
                <button 
                    onclick="triggerAdvert(${ad.id})" 
                    class="bg-gradient-to-br from-amber-600 to-amber-700 hover:from-amber-500 hover:to-amber-600 text-white py-3 px-4 rounded-xl text-xs sm:text-sm font-bold uppercase transition-all active:scale-95 shadow-lg shadow-amber-900/30 border border-amber-500/20 truncate"
                    title="${ad.sponsor ? ad.sponsor + ' - ' : ''}${ad.name}"
                >
                    ${ad.name}
                </button>
            `).join('');
        }

        async function triggerAdvert(advertId) {
            const advert = launcherAdverts.find(ad => ad.id === advertId);
            if (!advert) {
                console.error('Advert not found:', advertId);
                return;
            }
            
            try {
                const res = await fetch('/add-events', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'advert',
                        advert_id: advert.id,
                        name: advert.name,
                        sponsor: advert.sponsor,
                        duration: advert.duration,
                        imagePath: advert.imagePath
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    console.log('Advert triggered successfully:', advert.name);
                } else {
                    alert('Erro ao lan√ßar an√∫ncio: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Error triggering advert:', e);
                alert('Erro de conex√£o ao lan√ßar an√∫ncio');
            }
        }

        async function sync() {
            try {
                const res = await fetch('/state');
                if (!res.ok) throw new Error();
                const state = await res.json();
                currentState = state;
                
                // Sync clock offset
                const clientReceiveTime = Date.now() / 1000;
                clockOffset = state.server_time - clientReceiveTime;
                
                document.getElementById('status-dot').className = 'status-dot connected';
                document.getElementById('conn-text').innerText = 'Connected';

                document.getElementById('t1-display-name').innerText = state.team1_name || 'TEAM 1';
                document.getElementById('t2-display-name').innerText = state.team2_name || 'TEAM 2';
                
                document.getElementById('team1-btn-name').innerText = state.team1_name || 'Team 1';
                document.getElementById('team2-btn-name').innerText = state.team2_name || 'Team 2';
                document.getElementById('team1-formation-btn-name').innerText = state.team1_name || 'Team 1';
                document.getElementById('team2-formation-btn-name').innerText = state.team2_name || 'Team 2';
                
                document.getElementById('t1-display-dot').style.backgroundColor = 
                    colorPalette[state.team1_bg] || '#3b82f6';
                document.getElementById('t2-display-dot').style.backgroundColor = 
                    colorPalette[state.team2_bg] || '#f43f5e';
                
                document.getElementById('t1-score-val').innerText = state.team1_score;
                document.getElementById('t2-score-val').innerText = state.team2_score;

                document.getElementById('team1-btn').classList.toggle('active', selectedTeam === 'team1');
                document.getElementById('team2-btn').classList.toggle('active', selectedTeam === 'team2');

                // Update timer only if server state changed
                if (state.last_timer_update !== lastTimerUpdate) {
                    lastTimerUpdate = state.last_timer_update;
                    timerAnchor = state.timer_anchor;
                    timerOffset = state.timer_offset;
                    timerRunning = state.timer_running;
                    
                    if (timerRunning && !localTimerInterval) {
                        startLocalTimer();
                    } else if (!timerRunning && localTimerInterval) {
                        clearInterval(localTimerInterval);
                        localTimerInterval = null;
                    }
                    
                    updateTimerDisplay();
                }
                
            } catch(e) {
                document.getElementById('status-dot').className = 'status-dot disconnected';
                document.getElementById('conn-text').innerText = 'Disconnected';
            }
        }

        startLocalTimer();
        setInterval(sync, 1000);
        sync();
        selectTeam('team1');
        fetchLauncherAdverts();
    </script>
</body>
</html>