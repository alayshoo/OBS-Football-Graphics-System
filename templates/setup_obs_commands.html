<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OBS Commands ‚Äì Setup</title>
    <link rel="stylesheet" href="/static/css/shared.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.min.js"></script>
    <style>
        body {
            padding: 2rem;
        }

        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-header h1 {
            font-size: 1.5rem;
            font-weight: 800;
        }

        .nav-links {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .color-cell {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .color-preview {
            width: 28px;
            height: 28px;
            border-radius: 0.375rem;
            border: 2px solid var(--border-light);
            flex-shrink: 0;
            cursor: pointer;
            position: relative;
        }

        .color-preview input[type="color"] {
            position: absolute;
            inset: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
            border: none;
            padding: 0;
        }

        .shortcut-select {
            background: var(--glass-input);
            border: 1px solid var(--border-faint);
            color: var(--text);
            padding: 0.35rem 0.5rem;
            border-radius: var(--radius);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            font-weight: 700;
            cursor: pointer;
            min-width: 90px;
        }

        .shortcut-select:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2);
        }

        .shortcut-select option {
            background: var(--bg);
            color: var(--text);
        }

        .test-btn {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
            border: 1px solid rgba(16, 185, 129, 0.3);
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 700;
            font-family: 'Inter', sans-serif;
            transition: all 0.2s;
        }

        .test-btn:hover {
            background: rgba(16, 185, 129, 0.35);
        }

        .actions-cell {
            display: flex;
            gap: 0.35rem;
            align-items: center;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 0.75rem 1.25rem;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 0.875rem;
            z-index: 9999;
            animation: slideUp 0.3s ease, fadeOut 0.3s ease 2.7s forwards;
            pointer-events: none;
        }

        .toast.success {
            background: rgba(16, 185, 129, 0.9);
            color: white;
        }

        .toast.error {
            background: rgba(239, 68, 68, 0.9);
            color: white;
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
            }
        }
    </style>
    </head>
    <body>
    <div class="container">
        <!-- Header -->
        <div class="glass-card container" style="margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <h1 style="font-size: 1.5rem; font-weight: 800; color: white; margin: 0;">‚öôÔ∏è OBS Commands Setup</h1>
                    <div id="status-text" style="font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; display: flex; align-items: center; background: rgba(30, 41, 59, 0.5); padding: 0.5rem 0.75rem; border-radius: 9999px; border: 1px solid rgba(71, 85, 105, 0.5);">
                        <span id="status-dot" class="status-dot disconnected" style="width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 0.5rem;"></span>
                        <span id="conn-text">Connecting...</span>
                    </div>
                </div>
            
                <a href="/control" style="padding: 0.625rem 1rem; border-radius: var(--radius); background: rgba(100, 116, 139, 0.3); border: 1px solid var(--border-light); color: var(--text); text-decoration: none; transition: all 0.2s; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">
                    üîô
                </a>
            </div>
        </div>

        <!-- Status -->
        <div
        id="statusMessage"
        class="status-message"
        style="display: none"
        ></div>

        <!-- Commands Card -->
        <div class="glass-card">
        <div
            style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            "
        >
            <div class="section-title">Commands</div>
            <button id="btnCreate" class="btn btn-secondary">   
                ‚ûï Add Command
            </button>
        </div>

        <table class="table" id="commandsTable">
            <thead>
            <tr>
                <th style="width: 40px">#</th>
                <th>Name</th>
                <th style="width: 80px">Color</th>
                <th style="width: 120px">Shortcut</th>
                <th style="width: 130px">Actions</th>
            </tr>
            </thead>
            <tbody id="commandsBody">
            <!-- populated by JS -->
            </tbody>
        </table>

        <div id="emptyState" class="empty-state" style="display: none">
            No commands yet. Click <strong>+ Add Command</strong> to create
            one.
        </div>
        </div>
    </div>

    <!-- Toast container -->
    <div id="toastContainer"></div>

    <script>
        const socket = io();
        let commands = [];

        const SHORTCUT_OPTIONS = [
            "",
            "F13",
            "F14",
            "F15",
            "F16",
            "F17",
            "F18",
            "F19",
            "F20",
            "F21",
            "F22",
            "F23",
            "F24",
        ];

        // ===========================
        // Helpers
        // ===========================

        function showToast(message, type = "success") {
            const container = document.getElementById("toastContainer");
            const toast = document.createElement("div");
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function debounce(fn, ms = 500) {
            let timer;
            return function (...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), ms);
            };
        }

        // ===========================
        // Rendering
        // ===========================

        function renderCommands() {
            const tbody = document.getElementById("commandsBody");
            const empty = document.getElementById("emptyState");

            if (commands.length === 0) {
                tbody.innerHTML = "";
                empty.style.display = "block";
                return;
            }

            empty.style.display = "none";

            tbody.innerHTML = commands
                .map(
                (cmd, idx) => `
                <tr data-id="${cmd.id}">
                <td style="text-align:center; color: var(--text-muted);">
                    ${idx + 1}
                </td>
                <td>
                    <input
                    class="input-field"
                    type="text"
                    value="${escAttr(cmd.name || "")}"
                    placeholder="Command name"
                    data-field="name"
                    data-id="${cmd.id}"
                    />
                </td>
                <td>
                    <div class="color-cell">
                    <div
                        class="color-preview"
                        style="background:${cmd.color || "#000000"}"
                    >
                        <input
                        type="color"
                        value="${cmd.color || "#000000"}"
                        data-field="color"
                        data-id="${cmd.id}"
                        />
                    </div>
                    </div>
                </td>
                <td>
                    <select
                    class="shortcut-select"
                    data-field="shortcut"
                    data-id="${cmd.id}"
                    >
                    ${SHORTCUT_OPTIONS.map(
                        (s) =>
                        `<option value="${s}" ${
                            cmd.shortcut === s ? "selected" : ""
                        }>
                            ${s || "‚Äî none ‚Äî"}
                        </option>`
                    ).join("")}
                    </select>
                </td>
                <td>
                    <div class="actions-cell">
                    <button
                        class="test-btn"
                        data-id="${cmd.id}"
                        title="Test shortcut"
                    >
                        ‚ñ∂Ô∏è Test
                    </button>
                    <button
                        class="btn btn-danger btn-small"
                        data-delete-id="${cmd.id}"
                        title="Delete command"
                    >
                        ‚ùå
                    </button>
                    </div>
                </td>
                </tr>
            `
                )
                .join("");

            attachRowListeners();
        }

        function escAttr(str) {
            return str
                .replace(/&/g, "&amp;")
                .replace(/"/g, "&quot;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");
        }

        // ===========================
        // Row-level event listeners
        // ===========================

        function attachRowListeners() {
            // Name inputs (debounced)
            document.querySelectorAll('input[data-field="name"]').forEach(
                (input) => {
                    input.addEventListener(
                        "input",
                        debounce(function () {
                            const id = Number(this.dataset.id);
                            socket.emit("modify-obs-command", {
                                id,
                                name: this.value,
                            });
                        })
                    );
                }
            );

            // Color pickers
            document.querySelectorAll('input[data-field="color"]').forEach(
                (input) => {
                    input.addEventListener("input", function () {
                        const id = Number(this.dataset.id);
                        const preview = this.closest(".color-preview");
                        preview.style.background = this.value;
                        socket.emit("modify-obs-command", {
                        id,
                        color: this.value,
                        });
                    });
                }
            );

            // Shortcut selects
            document
                .querySelectorAll('select[data-field="shortcut"]')
                .forEach((select) => {
                    select.addEventListener("change", function () {
                        const id = Number(this.dataset.id);
                        socket.emit("modify-obs-command", {
                            id,
                            shortcut: this.value,
                        });
                    });
                });

            // Test buttons
            document.querySelectorAll(".test-btn").forEach((btn) => {
                btn.addEventListener("click", function () {
                    const id = Number(this.dataset.id);
                    socket.emit("trigger-obs-command", { id });
                });
            });

            // Delete buttons
            document.querySelectorAll("[data-delete-id]").forEach((btn) => {
                btn.addEventListener("click", function () {
                    const id = Number(this.dataset.deleteId);
                    const cmd = commands.find((c) => c.id === id);
                    const label = cmd?.name || `#${id}`;
                    if (confirm(`Delete command "${label}"?`)) {
                        socket.emit("delete-obs-command", { id });
                    }
                });
            });
        }

        // ===========================
        // Fetch initial data
        // ===========================

        async function fetchCommands() {
            try {
                const res = await fetch("/obs-commands");
                const data = await res.json();
                commands = data.obs_commands || [];
                renderCommands();
            } catch (err) {
                console.error("Failed to fetch commands:", err);
            }
        }

        // ===========================
        // Socket.IO listeners
        // ===========================

        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('status-dot');
            const connText = document.getElementById('conn-text');
            
            if (connected) {
                statusDot.classList.remove('disconnected');
                statusDot.classList.add('connected');
                connText.textContent = 'Connected';
            } else {
                statusDot.classList.remove('connected');
                statusDot.classList.add('disconnected');
                connText.textContent = 'Disconnected';
            }
        }

        socket.on("connect", () => {
            console.log('Connected to server');
            updateConnectionStatus(true);
            document.getElementById("statusMessage").style.display = "none";
        });

        socket.on("disconnect", () => {
            const el = document.getElementById("statusMessage");
            el.textContent = "Disconnected from server";
            el.className = "status-message error";
            el.style.display = "block";
            console.log('Disconnected from server');
            updateConnectionStatus(false);
        });

        socket.on("update-obs-commands", () => {
            fetchCommands();
        });

        socket.on("obs-command-created", (data) => {
            if (data.success) {
                showToast("Command created");
            } else {
                showToast(data.error || "Failed to create", "error");
            }
        });

        socket.on("obs-command-modified", (data) => {
            if (!data.success) {
                showToast(data.error || "Failed to save", "error");
            }
        });

        socket.on("obs-command-deleted", (data) => {
            if (data.success) {
                showToast("Command deleted");
            } else {
                showToast(data.error || "Failed to delete", "error");
            }
        });

        socket.on("obs-command-execution", (data) => {
            if (data.success) {
                showToast("Shortcut fired ‚úì");
            } else {
                showToast(data.error || "Execution failed", "error");
            }
        });

        // ===========================
        // Create button
        // ===========================

        document.getElementById("btnCreate").addEventListener("click", () => {
            socket.emit("create-obs-command", {});
        });

        // ===========================
        // Init
        // ===========================

        fetchCommands();
    </script>
</body>
</html>